# MVC Bridge Examples

**Runnable examples demonstrating Minimact MVC Bridge integration** 🌉

This project showcases how to use ASP.NET MVC Controllers with Minimact components, passing ViewModels with intelligent mutability controls.

---

## 🎯 What's Included

### 1. **Counter Example** (`/Examples/Counter`)
A simple counter demonstrating:
- ✅ Mutable state (`[Mutable] initialCount`, `initialStep`)
- ❌ Immutable properties (`userName`, `canReset`)
- Sync strategies (immediate, debounced)
- Local history tracking

### 2. **Todo List Example** (`/Examples/TodoList`)
A todo list demonstrating:
- ✅ Complex mutable state (arrays of objects)
- ❌ Server-authoritative business rules (`maxTodosAllowed`)
- Role-based permissions (`isAdminRole`)
- Filtering and categorization
- CRUD operations with server sync

---

## 🚀 Quick Start

### Prerequisites

- .NET 9.0 SDK
- Node.js (for Babel transpilation)
- Minimact CLI (`npm install -g @minimact/cli`)

### Setup

1. **Build the project:**
   ```bash
   cd examples/MvcBridgeExamples
   dotnet build
   ```

2. **Transpile TSX to C#:**
   ```bash
   # From the MvcBridgeExamples directory
   minimact transpile
   ```

3. **Run the application:**
   ```bash
   dotnet run
   ```

4. **Open in browser:**
   - Home: http://localhost:5000
   - Counter: http://localhost:5000/Examples/Counter
   - TodoList: http://localhost:5000/Examples/TodoList

---

## 📂 Project Structure

```
MvcBridgeExamples/
├── Controllers/
│   ├── ExamplesController.cs    # MVC controller with Counter & TodoList actions
│   └── HomeController.cs         # Landing page
├── ViewModels/
│   ├── CounterViewModel.cs       # ViewModel with [Mutable] attributes
│   └── TodoListViewModel.cs      # Complex ViewModel with nested objects
├── src/
│   └── pages/
│       ├── CounterPage.tsx       # Counter component using @minimact/mvc
│       └── TodoListPage.tsx      # TodoList component using @minimact/mvc
├── Generated/                     # Auto-generated by Babel
│   └── pages/
│       ├── CounterPage.cs        # Transpiled C# component
│       └── TodoListPage.cs       # Transpiled C# component
├── wwwroot/
│   ├── css/
│   │   └── app.css               # Shared styles
│   └── js/
│       └── minimact.js           # Minimact client runtime
├── Program.cs                     # App startup with MVC Bridge
└── README.md                      # This file
```

---

## 🔍 How It Works

### 1. Controller Prepares ViewModel (C#)

```csharp
// Controllers/ExamplesController.cs
public async Task<IActionResult> Counter()
{
    var viewModel = new CounterViewModel
    {
        // ❌ Immutable - Server authority
        UserName = User.Identity?.Name ?? "Guest",
        CanReset = true,

        // ✅ Mutable - Client can modify
        InitialCount = 0,
        InitialStep = 1
    };

    // Render Minimact page
    return await _renderer.RenderPage<CounterPage>(
        viewModel: viewModel,
        pageTitle: "Counter Example"
    );
}
```

### 2. ViewModel Defines Mutability (C#)

```csharp
// ViewModels/CounterViewModel.cs
public class CounterViewModel
{
    // ❌ IMMUTABLE - Server authority
    public string UserName { get; set; }
    public bool CanReset { get; set; }

    // ✅ MUTABLE - Client can modify
    [Mutable]
    public int InitialCount { get; set; }

    [Mutable]
    public int InitialStep { get; set; }
}
```

### 3. Component Uses MVC Bridge Hooks (TypeScript)

```tsx
// src/pages/CounterPage.tsx
import { useMvcState, useMvcViewModel } from '@minimact/mvc';

export function CounterPage() {
    // ❌ Immutable - Returns [value] only (no setter)
    const [userName] = useMvcState<string>('userName');
    const [canReset] = useMvcState<boolean>('canReset');

    // ✅ Mutable - Returns [value, setter]
    const [count, setCount] = useMvcState<number>('initialCount', {
        sync: 'immediate' // Syncs to server immediately
    });

    const [step, setStep] = useMvcState<number>('initialStep', {
        sync: 'debounced',
        syncDelay: 300 // Debounce input changes
    });

    const handleIncrement = () => {
        setCount(count + step); // ✅ Syncs to server via SignalR
    };

    return (
        <div>
            <h1>Welcome, {userName}!</h1>
            <div className="count">{count}</div>
            <button onClick={handleIncrement}>+ {step}</button>
        </div>
    );
}
```

### 4. Data Flow

```
User clicks button
    ↓
setCount(newValue) called
    ↓
useMvcState hook:
  1. Updates local state
  2. Checks HintQueue for template patch
  3. Applies cached patch (instant feedback!)
  4. Syncs to server via SignalR
    ↓
MinimactHub (server):
  1. Validates: Is 'initialCount' mutable? ✅ YES
  2. Updates component state
  3. Re-renders with new state
  4. Sends verification patches
    ↓
Client receives patches (usually matches prediction)
```

---

## 🎨 Features Demonstrated

### Counter Example

| Feature | Demonstrates |
|---------|-------------|
| Mutable state | `[Mutable]` attribute on ViewModel |
| Immutable props | Server-authoritative values |
| Sync strategies | immediate vs. debounced |
| Local state | History tracking (not synced) |
| Conditional rendering | Based on `canReset` permission |
| Type safety | TypeScript interface matching C# ViewModel |

### TodoList Example

| Feature | Demonstrates |
|---------|-------------|
| Complex state | Arrays of objects synced to server |
| CRUD operations | Add, toggle, delete todos |
| Role-based access | Admin-only delete button |
| Business rules | `maxTodosAllowed` enforced |
| Filtering | Category and completion filters |
| Computed values | Stats derived from state |
| Nested objects | `TodoItemViewModel` within `TodoListViewModel` |

---

## 🔒 Security Model

### Immutable Properties (Server Authority)

```csharp
// ❌ Cannot be modified from client
public string UserName { get; set; }
public bool IsAdminRole { get; set; }
public decimal Price { get; set; }
```

**Why?**
- Identity, roles, and permissions must be server-authoritative
- Pricing and business logic cannot be manipulated by client
- Security-sensitive data is read-only

### Mutable Properties (Client Control)

```csharp
// ✅ Can be modified and synced to server
[Mutable]
public int InitialCount { get; set; }

[Mutable]
public string InitialSearchQuery { get; set; }
```

**Why?**
- UI state (expanded/collapsed, selected tab)
- Form inputs before submission
- User preferences (theme, filters)

### Server-Side Validation

Even for mutable properties, the server **always validates**:

```csharp
// MinimactHub.cs
public async Task UpdateComponentState(string componentId, string stateKey, object value)
{
    // ✅ Check if this state is mutable
    if (!component.IsMvcStateMutable(stateKey))
    {
        await Clients.Caller.SendAsync("Error", "State is immutable");
        return; // Rejected!
    }

    // Apply update
    component.SetStateFromClient(stateKey, value);
    component.TriggerRender();
}
```

---

## 🛠️ Customization

### Adding a New Example

1. **Create ViewModel:**
   ```csharp
   // ViewModels/MyViewModel.cs
   public class MyViewModel
   {
       public string ServerData { get; set; }

       [Mutable]
       public string InitialClientData { get; set; }
   }
   ```

2. **Create Controller Action:**
   ```csharp
   // Controllers/ExamplesController.cs
   public async Task<IActionResult> MyExample()
   {
       var viewModel = new MyViewModel { /* ... */ };
       return await _renderer.RenderPage<MyPage>(viewModel, "My Example");
   }
   ```

3. **Create TSX Component:**
   ```tsx
   // src/pages/MyPage.tsx
   import { useMvcState } from '@minimact/mvc';

   export function MyPage() {
       const [serverData] = useMvcState<string>('serverData');
       const [clientData, setClientData] = useMvcState<string>('initialClientData');

       return <div>{/* ... */}</div>;
   }
   ```

4. **Transpile:**
   ```bash
   minimact transpile
   ```

5. **Run:**
   ```bash
   dotnet run
   ```

---

## 📚 Key Concepts

### 1. `useMvcState<T>` Hook

```tsx
const [value, setValue] = useMvcState<T>(propertyName, options);
```

**Parameters:**
- `propertyName` - ViewModel property name (camelCase)
- `options` - Optional configuration:
  - `sync`: `'immediate'` | `'debounced'` | `'manual'`
  - `syncDelay`: Debounce delay in ms (default: 300)
  - `defaultValue`: Fallback if property not found

**Returns:**
- For **immutable** properties: `[value]` (no setter)
- For **mutable** properties: `[value, setter]`

### 2. `useMvcViewModel<T>` Hook

```tsx
const viewModel = useMvcViewModel<MyViewModel>();
```

Returns the entire ViewModel (read-only). Useful for accessing multiple properties or nested objects.

### 3. Sync Strategies

| Strategy | Use Case | Behavior |
|----------|----------|----------|
| `immediate` | Buttons, toggles | Syncs on every change |
| `debounced` | Text inputs | Waits X ms after last change |
| `manual` | Batch operations | Explicit `flushMvcState()` call |

---

## 🐛 Debugging

### View ViewModel JSON

Both examples include a debug panel:

```tsx
<details className="debug-panel">
    <summary>🔍 Debug: View ViewModel JSON</summary>
    <pre>{JSON.stringify(viewModel, null, 2)}</pre>
    <h4>Mutability Metadata:</h4>
    <pre>{JSON.stringify(window.__MINIMACT_VIEWMODEL__?._mutability, null, 2)}</pre>
</details>
```

### Check Browser Console

```javascript
// View embedded ViewModel
console.log(window.__MINIMACT_VIEWMODEL__);

// View mutability metadata
console.log(window.__MINIMACT_VIEWMODEL__._mutability);
```

### Enable SignalR Logging

```csharp
// Program.cs
builder.Services.AddSignalR(options =>
{
    options.EnableDetailedErrors = true;
});
```

---

## 🎓 Learn More

- [MVC Bridge Implementation Plan](../../docs/MVC_BRIDGE_IMPLEMENTATION_PLAN.md)
- [MVC Bridge Quick Start](../../docs/MVC_BRIDGE_QUICK_START.md)
- [MVC Bridge Status](../../docs/MVC_BRIDGE_STATUS.md)
- [Minimact Documentation](../../README.md)

---

## ✅ Checklist

Before running:
- ✅ .NET 9.0 SDK installed
- ✅ Minimact.AspNetCore project built
- ✅ @minimact/mvc package built
- ✅ TSX files transpiled (`minimact transpile`)
- ✅ Static files served (`wwwroot/css/app.css`, `wwwroot/js/minimact.js`)

---

**Built with ❤️ using Minimact MVC Bridge** 🌉
