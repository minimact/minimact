{"version":3,"file":"tracker.js","sources":["../src/tracker.ts"],"sourcesContent":["/**\r\n * Mactic Tracker - Client-side change detection for event-driven search\r\n *\r\n * Stop crawling. Start running.\r\n */\r\n\r\nexport interface TrackerConfig {\r\n  apiKey: string;\r\n  apiEndpoint?: string;\r\n\r\n  // Category scoping (required)\r\n  category: string;\r\n\r\n  // Optional tags for fine-grained categorization\r\n  tags?: string[];\r\n\r\n  // Optional ontology path (future hierarchical categories)\r\n  ontologyPath?: string;\r\n\r\n  // Trust level hint\r\n  trustLevel?: 'unverified' | 'verified' | 'authoritative';\r\n\r\n  // Zones to watch for changes\r\n  watchZones: WatchZone[];\r\n\r\n  // Change detection options\r\n  checkInterval?: number; // ms between checks (default: 5000)\r\n  semanticThreshold?: number; // 0-1, how much change triggers notification (default: 0.1)\r\n\r\n  // Enable/disable features\r\n  enableMutationObserver?: boolean; // default: true\r\n  enablePeriodicCheck?: boolean; // default: true\r\n  enableDebugLogging?: boolean; // default: false\r\n}\r\n\r\nexport interface WatchZone {\r\n  selector: string;\r\n  importance: 'low' | 'medium' | 'high';\r\n}\r\n\r\nexport interface ChangeEvent {\r\n  url: string;\r\n  selector: string;\r\n  importance: string;\r\n  content: string;\r\n  title: string;\r\n  description: string;\r\n  timestamp: string;\r\n\r\n  // Category metadata\r\n  category: string;\r\n  tags: string[];\r\n  ontologyPath?: string;\r\n  trustLevel: string;\r\n\r\n  // Source metadata\r\n  domain: string;\r\n  language: string;\r\n\r\n  // Change metadata\r\n  changeType: 'content' | 'structure' | 'metadata';\r\n  oldHash?: string;\r\n  newHash: string;\r\n}\r\n\r\nexport class MacticTracker {\r\n  private config: TrackerConfig;\r\n  private contentHashes: Map<string, string> = new Map();\r\n  private mutationObserver?: MutationObserver;\r\n  private checkIntervalId?: number;\r\n  private initialized: boolean = false;\r\n\r\n  constructor(config: TrackerConfig) {\r\n    // Validate required fields\r\n    if (!config.apiKey) {\r\n      throw new Error('[Mactic] API key is required');\r\n    }\r\n    if (!config.category) {\r\n      throw new Error('[Mactic] Category is required');\r\n    }\r\n    if (!config.watchZones || config.watchZones.length === 0) {\r\n      throw new Error('[Mactic] At least one watch zone is required');\r\n    }\r\n\r\n    this.config = {\r\n      ...config,\r\n      apiEndpoint: config.apiEndpoint || 'https://api.itsmactic.com/api/events',\r\n      checkInterval: config.checkInterval || 5000,\r\n      semanticThreshold: config.semanticThreshold || 0.1,\r\n      enableMutationObserver: config.enableMutationObserver !== false,\r\n      enablePeriodicCheck: config.enablePeriodicCheck !== false,\r\n      enableDebugLogging: config.enableDebugLogging || false,\r\n      tags: config.tags || [],\r\n      trustLevel: config.trustLevel || 'unverified'\r\n    };\r\n\r\n    this.log('Tracker initialized', this.config);\r\n  }\r\n\r\n  /**\r\n   * Initialize the tracker and start monitoring for changes\r\n   */\r\n  public init(): void {\r\n    if (this.initialized) {\r\n      this.log('Tracker already initialized');\r\n      return;\r\n    }\r\n\r\n    // Wait for DOM to be ready\r\n    if (document.readyState === 'loading') {\r\n      document.addEventListener('DOMContentLoaded', () => this.startMonitoring());\r\n    } else {\r\n      this.startMonitoring();\r\n    }\r\n\r\n    this.initialized = true;\r\n    this.log('Tracker started');\r\n  }\r\n\r\n  /**\r\n   * Stop monitoring and cleanup\r\n   */\r\n  public destroy(): void {\r\n    if (this.mutationObserver) {\r\n      this.mutationObserver.disconnect();\r\n      this.mutationObserver = undefined;\r\n    }\r\n\r\n    if (this.checkIntervalId) {\r\n      clearInterval(this.checkIntervalId);\r\n      this.checkIntervalId = undefined;\r\n    }\r\n\r\n    this.contentHashes.clear();\r\n    this.initialized = false;\r\n    this.log('Tracker destroyed');\r\n  }\r\n\r\n  private startMonitoring(): void {\r\n    // Store initial hashes\r\n    this.config.watchZones.forEach(zone => {\r\n      const element = document.querySelector(zone.selector);\r\n      if (element) {\r\n        const hash = this.hashContent(this.getElementContent(element));\r\n        this.contentHashes.set(zone.selector, hash);\r\n        this.log(`Initial hash for ${zone.selector}:`, hash);\r\n      } else {\r\n        this.log(`Warning: Element not found: ${zone.selector}`);\r\n      }\r\n    });\r\n\r\n    // Set up MutationObserver for real-time detection\r\n    if (this.config.enableMutationObserver) {\r\n      this.mutationObserver = new MutationObserver(() => {\r\n        this.checkForChanges();\r\n      });\r\n\r\n      this.mutationObserver.observe(document.body, {\r\n        childList: true,\r\n        subtree: true,\r\n        characterData: true,\r\n        attributes: false // Ignore attribute changes for now\r\n      });\r\n\r\n      this.log('MutationObserver started');\r\n    }\r\n\r\n    // Set up periodic check as fallback\r\n    if (this.config.enablePeriodicCheck) {\r\n      this.checkIntervalId = window.setInterval(() => {\r\n        this.checkForChanges();\r\n      }, this.config.checkInterval);\r\n\r\n      this.log(`Periodic check started (every ${this.config.checkInterval}ms)`);\r\n    }\r\n\r\n    // Initial check\r\n    this.checkForChanges();\r\n  }\r\n\r\n  private async checkForChanges(): Promise<void> {\r\n    for (const zone of this.config.watchZones) {\r\n      const element = document.querySelector(zone.selector);\r\n      if (!element) continue;\r\n\r\n      const content = this.getElementContent(element);\r\n      const currentHash = this.hashContent(content);\r\n      const previousHash = this.contentHashes.get(zone.selector);\r\n\r\n      if (currentHash !== previousHash && previousHash !== undefined) {\r\n        this.log(`Change detected in ${zone.selector}`);\r\n        await this.notifyChange(zone, element, content, previousHash, currentHash);\r\n        this.contentHashes.set(zone.selector, currentHash);\r\n      }\r\n    }\r\n  }\r\n\r\n  private getElementContent(element: Element): string {\r\n    // Extract text content, stripping excessive whitespace\r\n    return (element.textContent || '')\r\n      .replace(/\\s+/g, ' ')\r\n      .trim();\r\n  }\r\n\r\n  private hashContent(content: string): string {\r\n    // Simple hash function (DJB2)\r\n    // For MVP - can be upgraded to crypto hash or embedding-based later\r\n    let hash = 5381;\r\n    for (let i = 0; i < content.length; i++) {\r\n      const char = content.charCodeAt(i);\r\n      hash = ((hash << 5) + hash) + char; // hash * 33 + char\r\n    }\r\n    return hash.toString(36);\r\n  }\r\n\r\n  private async notifyChange(\r\n    zone: WatchZone,\r\n    element: Element,\r\n    content: string,\r\n    oldHash: string,\r\n    newHash: string\r\n  ): Promise<void> {\r\n    const event: ChangeEvent = {\r\n      url: window.location.href,\r\n      selector: zone.selector,\r\n      importance: zone.importance,\r\n      content: content.substring(0, 10000), // Limit content size\r\n      title: document.title,\r\n      description: this.getMetaDescription(),\r\n      timestamp: new Date().toISOString(),\r\n\r\n      // Category metadata\r\n      category: this.config.category,\r\n      tags: this.config.tags || [],\r\n      ontologyPath: this.config.ontologyPath,\r\n      trustLevel: this.config.trustLevel || 'unverified',\r\n\r\n      // Source metadata\r\n      domain: window.location.hostname,\r\n      language: document.documentElement.lang || 'en',\r\n\r\n      // Change metadata\r\n      changeType: 'content',\r\n      oldHash,\r\n      newHash\r\n    };\r\n\r\n    this.log('Notifying change:', event);\r\n\r\n    try {\r\n      const response = await fetch(this.config.apiEndpoint!, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'X-API-Key': this.config.apiKey\r\n        },\r\n        body: JSON.stringify(event)\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      this.log('Change notification sent successfully:', result);\r\n    } catch (error) {\r\n      console.error('[Mactic] Failed to notify change:', error);\r\n      // Don't throw - we don't want to break the page\r\n    }\r\n  }\r\n\r\n  private getMetaDescription(): string {\r\n    const meta = document.querySelector('meta[name=\"description\"]');\r\n    return meta?.getAttribute('content') || '';\r\n  }\r\n\r\n  private log(message: string, ...args: any[]): void {\r\n    if (this.config.enableDebugLogging) {\r\n      console.log(`[Mactic] ${message}`, ...args);\r\n    }\r\n  }\r\n}\r\n\r\n// Global API for easy initialization\r\nexport const init = (config: TrackerConfig): MacticTracker => {\r\n  const tracker = new MacticTracker(config);\r\n  tracker.init();\r\n  return tracker;\r\n};\r\n\r\n// Export for UMD bundle\r\nif (typeof window !== 'undefined') {\r\n  (window as any).MacticTracker = {\r\n    MacticTracker,\r\n    init\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}